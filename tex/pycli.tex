\documentclass[12pt]{article} % use larger type; default would be 10pt

%packages
\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)
\usepackage{fancyhdr}
\usepackage{float}
\usepackage{geometry}
\usepackage{ulem}
\usepackage{soul}
\usepackage{color}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{array}
\usepackage{caption}
\usepackage{titling}
\usepackage{enumerate} 
\usepackage[dvipsnames]{xcolor}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[compact]{titlesec}


 %put box around figure captions
\makeatletter
\long\def\@makecaption#1#2{%
  \vskip\abovecaptionskip
  \sbox\@tempboxa{\fbox{#1: #2}}%
  \ifdim \wd\@tempboxa >\hsize
    \fbox{\parbox{\dimexpr\linewidth-2\fboxsep-2\fboxrule}{#1: #2}}\par
  \else
    \global \@minipagefalse
    \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
  \fi
  \vskip\belowcaptionskip}
\makeatother

%reduce space between sections
\titlespacing{\section}{0pt}{*1}{*0}
\titlespacing{\subsection}{0pt}{*1}{*0}
\titlespacing{\subsubsection}{0pt}{*0}{*0}


%no indent and modify distance between paragraphs
\setlength\parindent{0pt}
\setlength\parskip{12pt}

%set margins and line spacing
\geometry{margin=1in}
\linespread{1.2}
\geometry{letterpaper}

%math operators
\DeclareMathOperator{\E}{\mathbb{E}}

%set up header and page numbering
\pagestyle{fancy}
\lhead{Scientific Appendix}
\rhead{Timothy Liu}
\pagenumbering{arabic}

\hypersetup{  %set up url
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}



\title{PyCli Modeling}
\author{Timothy Liu}

\begin{document}

\maketitle

\tableofcontents

\newpage

% Introduction
\section{Introduction}
PyCli uses a discrete energy balance model for modeling temperatures across the globe. The planet is discretized into a grid with the size of each grid cell a fixed number of degrees latitude and longitude. Since the number of cells at each latitude band is fixed, the cells closer to the poles are smaller than the cells at the equator.

This document describes the PyCli backend climate model. Several versions of the model are implemented in C++ in the \textbf{src} folder. This document focuses on the physics of the model, and does not elaborate on how it is actually implemented.

The energy balance models described in \hyperref[sec:model]{Section 2} balances the incoming solar radiation with outgoing radiation to calculate the surface temperature. The incoming radiation is determined by the latitude of the cell, and the calculations for finding the incoming radiation for each cell is described in \hyperref[sec:radiation]{Section 3}.  The surface is treated as having one of several types: ocean, land, and ice. Each of the surface types has an associated albedo, and more details can be found in \hyperref[sec:surface]{Section 3}. The atmosphere is the most complex piece of the model, and is described in \hyperref[sec:atmos]{Section 4}. The greenhouse gas is calculated by considering the infrared transmissivity of the atmosphere, combined with the adding radiation forcing of carbon dioxide. Finally, a crude model for heat distribution between cells based on a 2D convolution is described in \hyperref[sec:heatflow]{Section 5}.

% Two Layer Energy Balance Model
\newpage
\section{Energy Balance Model}
\label{sec:model}

\subsection{Two Layer Energy Balance Model}

PyCli uses a fairly simple variation of the two layer energy balance model to calculate temperatures at each element in the grid. The same set of calculations are performed for each grid element, with the albedo and incoming solar radiation dependent on each individual element. The energy balance model is illustrated in Figure~\ref{fig:2layer}. Note that the PyCli model uses a variation of the two layer model described in this subsection - the modification is described in the next section.

\begin{figure}[H]
	\makebox[\textwidth][c]{\includegraphics[width=4in]{2layer.png}}
	\caption{Two layer energy balance model. Note that the radiation forcing from carbon dioxide is not included in the model.}
	\label{fig:2layer}
\end{figure}

The atmosphere is modeled as a single layer that is transparent to incoming solar radiation. The solar radiation is partly reflected (not illustrated) and the remaining absorbed solar radiation is re-emitted as infrared radiation. The emission from the surface is modeled by Planck's law as blackbody radiation. The atmosphere is partially opaque to the outgoing infrared radiation. The absorbed radiation is then re-emitted, with half of the radiation emitted into space and the other half emitted back to the surface.

The energy balance at the top of the atmosphere is described by:

$$E_{in}(1-A)  = (1-f) \sigma T_0^4 + f \sigma T_1^4$$

where $f$ is the fraction of infrared energy absorbed by the atmosphere, $A$ is the albedo of the surface, and $E_{in}$ is the average power per unit area of the surface. This equation balances the incoming solar radiation that is not reflected with the outgoing infrared energy emitted by the surface that passes through the atmosphere and the infrared energy emitted by the atmosphere, respectively. Note that in Figure~\ref{fig:2layer} the incoming energy is expressed as $\frac{1}{4}$ the sun's radiation while in the equation we have simplified this to the average power across all times of day.

The energy balance at the atmosphere layer is: 
$$2f\sigma T_1^4 = f\sigma T_o^4$$

which balances the infrared energy emitted by the atmosphere with the energy emitted by the surface absorbed by the atmosphere.

Combining these equations gives us equations for the temperature at the surface and the atmosphere:

$$T_0 = \bigg( \frac{(1-A)E_{in}}{\sigma(1-\frac{f}{2})}  \bigg)^{\frac{1}{4}}$$

$$T_1 =  2^{-\frac{1}{4}} T_0 $$

\subsection{Modified Two Layer Energy Balance Model}

The two layer energy balance model requires a fraction $f$ that describes the fraction of infrared radiation absorbed by the atmosphere. Specifically, the model demands an expression for $f$ in terms of the concentrations of different greenhouse gases, primarily carbon dioxide, water vapor, and ozone. However, computing this function is non-trivial, and the PyCli model makes a simplification that divides greenhouse gases into two categories.

Water vapor and ozone are considered ``constant greenhouse gases" whose concentration is fixed. The value of $f$ for just these two constant greenhouse gases is described in \hyperref[sec:atmos]{Section 4}. Carbon dioxide is considered a ``varying greenhouse gas" whose concentration can be changed and is an input to the model. Rather than calculating carbon dioxides contribution to $f$, the PyCli model uses the following empirical equation from Myhre et al. (1998):

$$ E_{CO_2} = 5.35 W m^{-2} ln \frac{[CO_2]}{280ppm}$$

The contribution from carbon dioxide is directly calculated using this formula and added to the downward emitted from the atmosphere towards the ground.


The energy balance at the top of the atmosphere remains the same:

$$ E_{in}(1-A)  = (1-f) \sigma T_0^4 + f \sigma T_1^4$$

While the energy balance between the surface and the atmosphere becomes:

The energy balance at the atmosphere layer is: 
$$2f\sigma T_1^4 + E_{CO_2} = f\sigma T_o^4$$

Combining these two equations again gives us expressions for the surface temperature:

$$\boxed{T_0 = \bigg[ \bigg((1-A)E_{in} + \frac{E_{CO_2}}{2}\bigg)\bigg(\frac{1}{\sigma(1-\frac{f}{2})}\bigg)\bigg] ^{\frac{1}{4}}}$$

% Incoming Solar Radiation
\newpage
\section{Incoming Solar Radiation}
\label{sec:radiation}

The solar radiation falling on the entire Earth is:

$$E_{total} = E_{sun} \pi r_{Earth}^2$$

Consider the Earth as a flat disc perpendicular to the direction of the sun. The sunlight falling on a horizontal strip is:

$$E_{strip} = 2 E_{sun} \int_{x_0}^{x_f} \sqrt{r_{E}^2 - x^2} dx$$


where $x_0$ and $x_f$ are the distances from the equator of the bottom and top of the strip. Integrating to the get the closed form:

$$E_{strip} = 2 E_{sun} \frac{1}{2} x \sqrt{r_{E}^2 - x^2} - \frac{1}{2} r_{E}^2 \tan^{-1}\bigg({\frac{x \sqrt{r_{E}^2 - x^2}}{x^2 - r_{E}^2 }}\bigg)\bigg]_{x_0}^{x_f}$$

$$E_{strip} = W_{sun} x \sqrt{r_{E}^2 - x^2} -  r_{E}^2 \tan^{-1}\bigg({\frac{x \sqrt{r_{E}^2 - x^2}}{x^2 - r_{E}^2 }}\bigg)\bigg]_{x_0}^{x_f}$$

However, the boundaries between the cells are defined by lines of latitude rather than as a distance from the equator of a flat disc. The substitution: 

$$x = r_{E} sin(\theta) $$

where $\theta$ is the line of latitude, is used to convert between $x$ and the line of latitude $\theta$. The incoming solar flux per
unit area along this strip is the above result divided by the surface area of the strip on a 3D sphere:

$$A_{strip} = \int_{\theta_{0}}^{\theta_{f}} 2 \pi r_{E} \cos{\theta} r d\theta $$

where $2 \pi r_{E} \cos{\theta}$ is the circumference of the earth at a certain latitude and $r d\theta$ is the north-south distance of a differential along the surface of the earth. This can be simplified to:

$$A_{strip} =  2 \pi r_{E}^2 \sin{\theta}\bigg]_{x_0}^{x_f} $$

The average solar flux falling on a cell in a strip bound by $\theta_0$ and $\theta_f$ is:

$$E_{in} = \frac{E_{strip}}{A_{strip}}$$

$$\boxed{E_{in} = E_{sun}\frac{x \sqrt{r_{E}^2 - x^2} -  r_{E}^2 \tan^{-1}\bigg({\frac{x \sqrt{r_{E}^2 - x^2}}{x^2 - r_{E}^2 }}\bigg)\bigg]_{r_{E}\sin(\theta_0)}^{r_{E}\sin(\theta_f)}}{2 \pi r_{E}^2 \sin{\theta}]_{\theta_0}^{\theta^f}}}$$

Please note that the argument of the $\tan^{-1}$ approaches $-\infty$ as $x$ approaches $r_{E}$. The limit of $\tan^{-1}$ approaches $-\frac{\pi}{2}$ so when $x = r_{E}$ the numerator reduces to:

$$x \sqrt{r_{E}^2 - x^2} -  r_{E}^2 \tan^{-1}(-\infty)$$

$$0 -  r_{E}^2 (-\frac{\pi}{2})$$

$$\frac{r_{E}^2 \pi}{2}$$

% Surface
\newpage
\section{Surface}
\label{sec:surface}


% Atmosphere
\newpage
\section{Atmosphere}
\label{sec:atmos}


\subsection{Infrared transmissivity}

Infrared transmissivity is the fraction of energy radiated by the Earth's surface that escapes into space. On an airless world, the infrared transmissivity should be 1. On a planet with an atmosphere, greenhouse gases block some of the energy.

The energy emitted by the Earth is approximated by blackbody radiation described by Planck's law:

Figure X illustrates Planck's law at different temperatures close to Earth's surface temperature. The energy absorbed by the atmosphere can be calculated by integrating over the absorption spectrum of greenhouse gases. Assume we have a function $A(\lambda)$ that describes the fraction of energy absorbed by the atmosphere at different frequencies. The total fraction of energy absorbed by the atmosphere is then:

$$\frac{\int_{\lambda_0}^{\lambda_f} A(\lambda) B(\lambda, T) d\lambda}{\int_{\lambda_0}^{\lambda_f} B(\lambda, T) d\lambda }$$

Note that we've reformulated Planck's law in terms of wavelength instead of frequency. We can use a Gaussian distribution to approximate the energy distribution from Planck's law. This substitution is valid because at the temperatures we're interested in (Earth's surface temperature) the energy distribution from Planck's law is well approximated by a Gaussian. Since the integral of a Gaussian is 1, this also simplifies our expression to:

$$\int_{\lambda_0}^{\lambda_f} A(\lambda) B'(\lambda, T) d\lambda$$

where $B'$ is the Gaussian approximation of $B(\lambda, T)$. However, note that the function $B`(\lambda, T)$ is dependent on surface temperature, which is the expression we're ultimately trying to solve for! Another approximation made in the PyCli model is that the \textit{normalized} energy emission curve given by Planck's Law at the temperatures we're interested is not strongly temperature dependent.

\subsection{Creating an expression for $A(\lambda)$}

In the previous step we assumed we had an expression for $A(\lambda)$ to calculate the fraction of energy absorbed. This section describes how we actually derive this expression. Figure~\ref{fig:absorption} gives the fraction of energy absorbed by water vapor and carbon dioxide, the two greenhouse gases considered by PyCli.

\begin{figure}[H]
	\makebox[\textwidth][c]{\includegraphics[width=3.8in]{absorption.jpg}}
	\caption{Fraction of radiation emitted from Earth's surface absorbed by selected gases in the atmosphere.}
	\label{fig:absorption}
\end{figure}

The expression $A(\lambda)$ is illustrated in Figure~\ref{fig:absorption}.

The PyCli model treats the atmosphere as a uniform layer above the surface. The atmosphere is transparent to incoming light, but absorbs a fraction of the outgoing infrared energy. The absorption is described by the function $A(\lambda)$. Half of the infrared energy absorbed by the atmosphere is emitted upwards into space while the other half is emitted downwards to the surface.

The concentration of greenhouse gases is taken into account in two ways. Gases that are approximated as having fixed concentration (water vapor, oxygen) are included in the shell atmosphere model. 
%heat flow
\newpage
\section{Heat Flow}
\label{sec:heatflow}

%Appendix 1
\newpage
\section{Appendix 1: Variable names}

\begin{center}
\begin{tabular}{|m{2 cm}| m{6 cm}| m{6 cm}|} \hline
\textbf{Variable} & \textbf{Description} & \textbf{Units}\\ \hline
$E_in$ & Incoming solar radiation & watts per square meter\\ \hline
$A$ & Albedo & fraction\\ \hline
$f$  & fraction of outgoing infrared radiation absorbed by atmosphere & fraction \\ \hline
\end{tabular}
\end{center}


% references
\newpage
\section{References}
\label{sec:references}



\end{document}
